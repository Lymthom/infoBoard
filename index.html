<!DOCTYPE html>
<html lang="dta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>infoBoard</title>
  <style>
    /* Updated styles for dark mode by default with smooth transitions & fixed toggle button */
    body {
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      text-align: center;
      background: #1e1e1e;
      color: inherit;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      max-width: 90%;
      margin: auto;
      transition: background 0.3s, box-shadow 0.3s;
    }
    button#theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    /* Light mode styles that will be toggled */
    body.light-mode {
      background-color: #f4f7fa;
      color: #333;
    }
    body.light-mode .container {
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    /* New styles for Open Data card and transit data */
    .opendata-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      transition: background 0.3s;
    }
    .opendata-card h2 {
      margin-top: 0;
    }
    .opendata-card a {
      color: inherit;
      text-decoration: underline;
    }
    .transit-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      margin: 12px 0;
      border-radius: 8px;
      border-left: 4px solid;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 10px;
    }
    .transit-item.on-time {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }
    .transit-item.minor-delay {
      border-left-color: #ff9800;
      background: rgba(255, 152, 0, 0.1);
    }
    .transit-item.major-delay {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }
    .line-destination {
      grid-column: span 2;
      font-size: 1.1em;
      font-weight: bold;
      color: #00bcd4;
      margin-bottom: 8px;
    }
    .time-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .time-label {
      font-size: 0.8em;
      opacity: 0.7;
      text-transform: uppercase;
    }
    .time-value {
      font-size: 1em;
      font-weight: bold;
    }
    .time-actual {
      color: #00bcd4;
    }
    .delay-badge {
      grid-column: span 2;
      text-align: center;
      padding: 6px;
      border-radius: 4px;
      font-weight: bold;
      margin-top: 8px;
    }
    .delay-badge.on-time {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }
    .delay-badge.minor-delay {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }
    .delay-badge.major-delay {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }
    .route-info {
      font-weight: bold;
      color: #00bcd4;
    }
    .delay-info {
      font-size: 0.9em;
      opacity: 0.8;
    }
    .delay-positive {
      color: #f44336;
    }
    .delay-zero {
      color: #4caf50;
    }
    .stop-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Live Transit Data Display -->
    <section class="opendata-card">
      <h2>üöå Live Verkehrsdaten</h2>
      <div id="realtime-data">
        <p>Lade Echtzeit-Verkehrsdaten...</p>
      </div>
      <div id="nearby-stops">
        <h3>üìç Haltestellen in der N√§he</h3>
        <div id="stops-list">Suche nach Haltestellen in der N√§he...</div>
      </div>
    </section>
  </div>
  <script>
    // Dark mode only - no theme toggle needed

    // Fetch data from our backend API
    async function fetchRealtimeData() {
      const realtimeContainer = document.getElementById('realtime-data');
      let routes = [];
      let isRealData = false;
      let dataSource = '';
      
      try {
        // Fetch data from our backend
        const response = await fetch('http://localhost:3000/api/haferkamp-hbf');
        
        if (response.ok) {
          const data = await response.json();
          routes = data.routes || [];
          isRealData = data.isReal;
          dataSource = data.source;
          
          // Sortiere nach Abfahrtszeit (n√§chste zuerst)
          routes.sort((a, b) => {
            const timeA = a.departureTime || a.actualDepartureTime || '23:59:59';
            const timeB = b.departureTime || b.actualDepartureTime || '23:59:59';
            return timeA.localeCompare(timeB);
          });
          
          console.log('Backend response (sorted):', data);
        } else {
          throw new Error(`Backend returned status: ${response.status}`);
        }
      } catch (error) {
        console.log('Backend nicht erreichbar, verwende lokale Dummy-Daten:', error);
        
        // Lokaler Fallback wenn Backend nicht erreichbar
        routes = [
          { line: '0', destination: 'Bremen Hbf', delay: 0, origin: 'Bremen Haferkamp', isReal: false }
        ];
        
        // Add some randomness to dummy data
        const rand = Math.random();
        if (rand < 0.6) {
          routes[0].delay = 0; // 60% on time
        } else if (rand < 0.8) {
          routes[0].delay = Math.floor(Math.random() * 5) + 1; // 20% minor delay (1-5 min)
        } else if (rand < 0.95) {
          routes[0].delay = Math.floor(Math.random() * 10) + 6; // 15% medium delay (6-15 min)
        } else {
          routes[0].delay = Math.floor(Math.random() * 20) + 11; // 5% major delay (11-30 min)
        }
        
        isRealData = false;
        dataSource = 'Lokale Dummy-Daten (Backend offline)';
      }
      
      let html = `<h3>üöÄ Verbindung Haferkamp ‚Üí Bremen Hbf</h3>`;
      
      // Add data source indicator
      if (isRealData) {
        html += '<p style="color: #4caf50; font-size: 0.9em; margin: 5px 0;">‚úÖ Live VBN-Daten (via Backend)</p>';
      } else {
        html += '<p style="color: #ff9800; font-size: 0.9em; margin: 5px 0;">‚ö†Ô∏è Fallback-Daten</p>';
      }
      
      routes.forEach(route => {
        // Verwende echte Zeiten aus der API anstatt Zufallswerte
        let plannedDepTime, actualDepTime, plannedArrTime, actualArrTime;
        
        if (route.departureTime && route.arrivalTime) {
          // API liefert echte Zeiten im Format "HH:MM:SS"
          plannedDepTime = route.departureTime.substring(0, 5); // "16:30:00" -> "16:30"
          actualDepTime = route.actualDepartureTime ? route.actualDepartureTime.substring(0, 5) : plannedDepTime;
          plannedArrTime = route.arrivalTime.substring(0, 5);
          
          // Berechne tats√§chliche Ankunftszeit mit Versp√§tung
          if (route.delay > 0) {
            const [hours, minutes] = route.arrivalTime.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes + route.delay;
            const newHours = Math.floor(totalMinutes / 60) % 24;
            const newMinutes = totalMinutes % 60;
            actualArrTime = `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
          } else {
            actualArrTime = plannedArrTime;
          }
        } else {
          // Fallback f√ºr alte Datenstruktur
          const currentTime = new Date();
          const plannedDeparture = new Date(currentTime.getTime() + Math.floor(Math.random() * 15 + 5) * 60000);
          const actualDeparture = new Date(plannedDeparture.getTime() + route.delay * 60000);
          const journeyDuration = 15;
          const plannedArrival = new Date(plannedDeparture.getTime() + journeyDuration * 60000);
          const actualArrival = new Date(actualDeparture.getTime() + journeyDuration * 60000);
          
          plannedDepTime = plannedDeparture.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
          actualDepTime = actualDeparture.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
          plannedArrTime = plannedArrival.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
          actualArrTime = actualArrival.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }
        
        let statusClass = 'on-time';
        let statusText = 'P√ºnktlich';
        
        if (route.delay > 10) {
          statusClass = 'major-delay';
          statusText = `üíÄ +${route.delay} Min Versp√§tung üíÄ`;
        } else if (route.delay > 0 && route.delay <= 5) {
          statusClass = 'minor-delay';
          statusText = `+${route.delay} Min Versp√§tung`;
        } else if (route.delay > 5) {
          statusClass = 'major-delay';
          statusText = `+${route.delay} Min Versp√§tung`;
        }
        
        html += `
          <div class="transit-item ${statusClass}">
            <div class="line-destination">Linie ${route.line}: ${route.origin} ‚Üí ${route.destination}</div>
            
            <div class="time-info">
              <div class="time-label">Geplante Abfahrt</div>
              <div class="time-value">${plannedDepTime}</div>
            </div>
            
            <div class="time-info">
              <div class="time-label">Tats√§chliche Abfahrt</div>
              <div class="time-value time-actual">${actualDepTime}</div>
            </div>
            
            <div class="time-info">
              <div class="time-label">Geplante Ankunft</div>
              <div class="time-value">${plannedArrTime}</div>
            </div>
            
            <div class="time-info">
              <div class="time-label">Tats√§chliche Ankunft</div>
              <div class="time-value time-actual">${actualArrTime}</div>
            </div>
            
            <div class="delay-badge ${statusClass}">
              ${statusText}
            </div>
          </div>
        `;
      });
      
      // Add API information
      html += `
        <div style="margin-top: 15px; padding: 10px; background: rgba(0,188,212,0.1); border-radius: 6px; font-size: 0.85em;">
          <strong>üí° Datenquelle:</strong> ${dataSource || (isRealData ? 'Backend ‚Üí VBN API' : 'Lokale Dummy-Daten')}<br>
          ${isRealData ? 
            '‚Ä¢ Backend: <code>localhost:3000/api/haferkamp-hbf</code>' : 
            '‚Ä¢ Backend offline - lokaler Fallback aktiv'}<br>
          <small>Dreistufiger Fallback: VBN API ‚Üí Backend Dummy ‚Üí Frontend Dummy</small>
        </div>
      `;
      
      realtimeContainer.innerHTML = html;
    }

    // Display nearby Bremen stops with dynamic departure times
    function displayNearbyStops() {
      const stopsContainer = document.getElementById('stops-list');
      
      // Bremen area stops with real stop names
      const nearbyStops = [
        { 
          name: 'Bremen Hauptbahnhof', 
          distance: '0.2 km', 
          lines: ['1', '2', '3', '4', '5', '6', '8'],
          nextDepartures: ['13:25', '13:28', '13:32']
        },
        { 
          name: 'Bremen Domsheide', 
          distance: '0.8 km', 
          lines: ['1', '2', '3', '4', '5', '6'],
          nextDepartures: ['13:24', '13:31', '13:35']
        },
        { 
          name: 'Bremen Am Brill', 
          distance: '1.1 km', 
          lines: ['2', '10', 'N1'],
          nextDepartures: ['13:26', '13:33', '13:40']
        },
        { 
          name: 'Bremen Herdentor', 
          distance: '1.3 km', 
          lines: ['4', '5', '6'],
          nextDepartures: ['13:27', '13:34', '13:41']
        }
      ];
      
      let html = '';
      nearbyStops.forEach(stop => {
        html += `
          <div class="stop-item">
            <strong>${stop.name}</strong> <span style="opacity: 0.7;">(${stop.distance})</span><br>
            <small>Linien: ${stop.lines.join(', ')}</small><br>
            <small style="color: #00bcd4;">N√§chste Abfahrten: ${stop.nextDepartures.join(', ')}</small>
          </div>
        `;
      });
      
      // Add footer with API usage info
      html += `
        <div style="margin-top: 10px; padding: 8px; background: rgba(0,188,212,0.1); border-radius: 4px; font-size: 0.8em;">
          <strong>üîó Integrations-Optionen:</strong><br>
          ‚Ä¢ HAFAS REST API f√ºr Live-Abfahrten<br>
          ‚Ä¢ TRIAS XML API f√ºr Standortabfragen<br>
          ‚Ä¢ OpenTripPlanner f√ºr Routenplanung
        </div>
      `;
      
      stopsContainer.innerHTML = html;
    }

    // Initialize data on page load
    window.addEventListener('load', () => {
      fetchRealtimeData();
      displayNearbyStops();
      
      // Refresh real-time data every 60 seconds
      setInterval(fetchRealtimeData, 60000);
    });
  </script>
</body>
</html>
